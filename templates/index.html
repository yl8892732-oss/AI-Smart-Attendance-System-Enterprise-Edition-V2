{% extends "base.html" %}

{% block content %}
<style>
    /* UI Enhancement: Professional terminal aesthetics */
    .camera-box {
        border: 12px solid #fff;
        outline: 1px solid #e2e8f0;
        border-radius: 30px;
        overflow: hidden;
        max-width: 600px;
        background-color: #0f172a;
        position: relative;
    }

    #video {
        width: 100%;
        display: block;
        transform: scaleX(-1); /* Mirror effect for user convenience */
    }

    #status-overlay {
        background: linear-gradient(180deg, transparent, rgba(15, 23, 42, 0.85));
        font-weight: 600;
        padding: 25px 0;
        position: absolute;
        bottom: 0;
        width: 100%;
        color: white;
        transition: all 0.3s ease;
        letter-spacing: 0.5px;
    }

    .btn-indigo {
        background-color: #4f46e5;
        color: white;
        border: none;
    }

    .btn-indigo:hover {
        background-color: #4338ca;
        color: white;
    }

    .btn-action {
        border-radius: 50px;
        padding: 12px 35px;
        font-weight: 600;
    }

    /* Animation: Smooth feedback transition */
    .alert-success-custom {
        background-color: #f0fdf4;
        border: 1px solid #22c55e;
        color: #166534;
        border-radius: 12px;
        animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="text-center py-4">
    <div class="camera-box mx-auto shadow-lg">
        <video id="video" autoplay playsinline></video>
        <div id="status-overlay">Initializing System Hardware...</div>
    </div>

    <div class="mt-4">
        <button id="btn-toggle" onclick="toggleScan()" class="btn btn-indigo btn-action shadow-sm">
            <i class="bi bi-pause-fill me-2"></i>Pause Recognition
        </button>
    </div>

    <div id="result-area" class="mx-auto mt-4" style="max-width: 400px; min-height: 80px;">
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const statusOverlay = document.getElementById('status-overlay');
    const resultArea = document.getElementById('result-area');
    const btnToggle = document.getElementById('btn-toggle');

    let isScanning = true;
    let scanInterval = null;

    /**
     * Initializes hardware video stream with standard resolution constraints.
     */
    async function initCamera() {
        try {
            const constraints = {
                video: {
                    facingMode: "user",
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            statusOverlay.innerText = "Scanning Biometric Data...";
            beginRecognitionLoop();
        } catch (err) {
            statusOverlay.innerText = "Error: Access to Camera Denied";
            console.error("[SYS] Camera Access Failed:", err);
        }
    }

    /**
     * Captures frame and dispatches to recognition API.
     */
    async function executeInference() {
        if (!isScanning) return;

        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        const payload = { image: canvas.toDataURL('image/jpeg', 0.8) };

        try {
            const response = await fetch('/api/recognize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            // Handle server-side recognition states
            if (data.status === 'success') {
                displaySuccess(data.name);
            } else if (data.status === 'cool_down') {
                statusOverlay.innerText = `Active Cooldown: ${data.name}`;
            } else if (data.status === 'unknown') {
                statusOverlay.innerText = "Searching for Valid Identity...";
            }
        } catch (err) {
            console.error("[API] Recognition Transaction Failed:", err);
        }
    }

    function displaySuccess(name) {
        resultArea.innerHTML = `
            <div class="alert alert-success-custom p-3 shadow-sm">
                <i class="bi bi-check-circle-fill me-2"></i>
                Verified: <strong>${name}</strong>
            </div>`;
        statusOverlay.style.background = "rgba(34, 197, 94, 0.85)";
        statusOverlay.innerText = "Identity Verified Successfully";
        enforceSystemPause(3000);
    }

    function beginRecognitionLoop() {
        if (scanInterval) clearInterval(scanInterval);
        scanInterval = setInterval(executeInference, 1500);
        isScanning = true;
    }

    function toggleScan() {
        if (isScanning) {
            isScanning = false;
            clearInterval(scanInterval);
            btnToggle.innerHTML = '<i class="bi bi-play-fill me-2"></i>Resume Scanning';
            statusOverlay.innerText = "System Paused";
        } else {
            btnToggle.innerHTML = '<i class="bi bi-pause-fill me-2"></i>Pause Recognition';
            beginRecognitionLoop();
        }
    }

    /**
     * Prevents redundant transactions after successful recognition.
     */
    function enforceSystemPause(ms) {
        isScanning = false;
        setTimeout(() => {
            if (btnToggle.innerText.includes("Pause")) {
                isScanning = true;
                statusOverlay.style.background = "";
                statusOverlay.innerText = "Scanning Biometric Data...";
            }
        }, ms);
    }

    window.onload = initCamera;
</script>
{% endblock %}
