{% extends "base.html" %}

{% block content %}
<style>
    /* ä¼ä¸šçº§æç®€ç¾åŒ–æ ·å¼ */
    .camera-box {
        border: 12px solid #fff;
        outline: 1px solid #e2e8f0;
        border-radius: 30px;
        overflow: hidden;
        max-width: 600px;
        background-color: #000;
        position: relative;
    }

    #video {
        width: 100%;
        display: block;
        transform: scaleX(-1); /* é•œåƒæ˜¾ç¤º */
    }

    #status-overlay {
        background: linear-gradient(180deg, transparent, rgba(15, 23, 42, 0.8));
        font-weight: 600;
        padding: 25px 0;
        position: absolute;
        bottom: 0;
        width: 100%;
        color: white;
        transition: all 0.3s ease;
    }

    .btn-indigo {
        background-color: #4f46e5;
        color: white;
        border: none;
    }

    .btn-indigo:hover {
        background-color: #4338ca;
        color: white;
    }

    .btn-action {
        border-radius: 50px;
        padding: 12px 35px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    #result-area {
        min-height: 60px;
    }

    /* æˆåŠŸæ‰“å¡çš„å¹³æ»‘åŠ¨ç”» */
    .alert-success-custom {
        background-color: #ecfdf5;
        border: 1px solid #10b981;
        color: #065f46;
        border-radius: 12px;
        animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="text-center py-4">
    <div class="camera-box mx-auto shadow-lg">
        <video id="video" autoplay playsinline></video>
        <div id="status-overlay">æ­£åœ¨åˆå§‹åŒ–æ‘„åƒå¤´...</div>
    </div>

    <div class="mt-4">
        <button id="btn-toggle" onclick="toggleScan()" class="btn btn-indigo btn-action shadow-sm">
            <i class="bi bi-pause-fill me-2"></i>æš‚åœæ‰«æ
        </button>
    </div>

    <div id="result-area" class="mx-auto mt-4" style="max-width: 400px;">
        </div>
</div>

<script>
    const video = document.getElementById('video');
    const statusOverlay = document.getElementById('status-overlay');
    const resultArea = document.getElementById('result-area');
    const btnToggle = document.getElementById('btn-toggle');

    let scanning = true;
    let intervalId = null;

    // 1. åˆå§‹åŒ–æ‘„åƒå¤´ï¼šèµ„æ·±ç¨‹åºå‘˜é‡‡ç”¨æ ‡å‡†å¼‚æ­¥æµ
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: "user",
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            });
            video.srcObject = stream;
            statusOverlay.innerText = "ğŸ” æ­£åœ¨æ‰«æå‘˜å·¥é¢éƒ¨...";
            startScanning();
        } catch (err) {
            statusOverlay.innerText = "âŒ æ‘„åƒå¤´å¼€å¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™";
            console.error("Camera Error:", err);
        }
    }

    // 2. æŠ“æ‹å¹¶ä¸Šä¼ ï¼šæ ¸å¿ƒæ‰“å¡é€šè®¯é€»è¾‘
    async function captureAndSend() {
        if (!scanning) return;

        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        const imageData = canvas.toDataURL('image/jpeg', 0.8);

        try {
            const response = await fetch('/api/recognize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            });

            const data = await response.json();

            if (data.status === 'success') {
                // æˆåŠŸï¼šæ˜¾ç¤ºç»“æœå¹¶è§¦å‘å†·å´
                resultArea.innerHTML = `
                    <div class="alert alert-success-custom p-3 shadow-sm">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <strong>${data.name}</strong> æ‰“å¡æˆåŠŸï¼
                    </div>`;
                statusOverlay.style.background = "rgba(16, 185, 129, 0.8)";
                statusOverlay.innerText = "âœ… è¯†åˆ«æˆåŠŸ";
                tempPause();
            } else if (data.status === 'cool_down') {
                statusOverlay.innerText = `â˜•ï¸ ${data.name}ï¼Œè¯·å‹¿é¢‘ç¹æ‰“å¡`;
            } else if (data.status === 'unknown') {
                statusOverlay.innerText = "ğŸ‘€ æœªè¯†åˆ«åˆ°æœ‰æ•ˆå‘˜å·¥";
            }
        } catch (err) {
            console.error("API Error:", err);
        }
    }

    // 3. è¿è¡Œæ§åˆ¶é€»è¾‘
    function startScanning() {
        if (intervalId) clearInterval(intervalId);
        intervalId = setInterval(captureAndSend, 1500); // æ¯1.5ç§’è¯†åˆ«ä¸€æ¬¡ï¼Œå¹³è¡¡æ€§èƒ½ä¸å‡†ç¡®åº¦
        scanning = true;
    }

    function toggleScan() {
        if (scanning) {
            scanning = false;
            clearInterval(intervalId);
            btnToggle.innerHTML = '<i class="bi bi-play-fill me-2"></i>ç»§ç»­æ‰«æ';
            statusOverlay.innerText = "â¸ å·²æš‚åœ";
        } else {
            btnToggle.innerHTML = '<i class="bi bi-pause-fill me-2"></i>æš‚åœæ‰«æ';
            startScanning();
        }
    }

    function tempPause() {
        // æˆåŠŸè¯†åˆ«åæš‚åœ3ç§’ï¼Œç»™å‘˜å·¥ååº”æ—¶é—´ï¼Œé˜²æ­¢é‡å¤å†™å…¥
        scanning = false;
        setTimeout(() => {
            if (btnToggle.innerText.includes("æš‚åœ")) { // åªæœ‰åœ¨éæ‰‹åŠ¨æš‚åœçš„æƒ…å†µä¸‹æ‰æ¢å¤
                scanning = true;
                statusOverlay.style.background = "";
                statusOverlay.innerText = "ğŸ” æ­£åœ¨æ‰«æå‘˜å·¥é¢éƒ¨...";
            }
        }, 3000);
    }

    // å¯åŠ¨ç³»ç»Ÿ
    window.onload = initCamera;
</script>
{% endblock %}