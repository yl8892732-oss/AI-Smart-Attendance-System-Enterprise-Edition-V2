{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card shadow-sm border-0 p-4 bg-white">
            <h5 class="fw-bold mb-4 text-center">New Employee Enrollment</h5>
            <div class="camera-preview mb-3" style="border-radius: 20px; overflow: hidden; height: 300px; background: #000;">
                <video id="video" autoplay playsinline style="width:100%; height:100%; object-fit: cover; transform: scaleX(-1);"></video>
            </div>
            <form id="regForm">
                <div class="mb-3">
                    <label class="form-label small fw-bold">Employee ID</label>
                    <input type="text" id="emp_id" class="form-control" placeholder="Unique ID" required>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">Full Name</label>
                    <input type="text" id="name" class="form-control" placeholder="Legal Name" required>
                </div>
                <div class="mb-4">
                    <label class="form-label small fw-bold">Job Position</label>
                    <input type="text" id="position" class="form-control" placeholder="e.g. Manager, HR" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold shadow-sm" id="submitBtn">Submit Enrollment</button>
            </form>
            <div id="msg" class="mt-3"></div>
            <canvas id="canvas" style="display:none;"></canvas>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const form = document.getElementById('regForm');

    async function initCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
    }

    form.onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        const payload = {
            emp_id: document.getElementById('emp_id').value,
            name: document.getElementById('name').value,
            position: document.getElementById('position').value,
            image: canvas.toDataURL('image/jpeg', 0.8)
        };

        const res = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await res.json();

        const msgDiv = document.getElementById('msg');
        if (result.status === 'success') {
            msgDiv.innerHTML = `<div class="alert alert-success">✅ ${result.msg}</div>`;
            setTimeout(() => location.href = '/employees', 1500);
        } else {
            msgDiv.innerHTML = `<div class="alert alert-danger">❌ ${result.msg}</div>`;
            btn.disabled = false;
        }
    };
    window.onload = initCamera;
</script>
{% endblock %}